<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sminex Club | Mobile System</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg: #0b0c0e;
            --card: #15171b;
            --border: #2d333b;
            --text: #E6E6E6;
            --sub: #8b949e;
            --input-bg: #0b0c0e;
            --gold: #C9A66B;
            --gold-gradient: linear-gradient(135deg, #C9A66B 0%, #8C734B 100%);
            --shadow: 0 10px 40px rgba(0,0,0,0.6);
            --chart-grid: #2d333b;
            --chart-text: #8b949e;
        }

        [data-theme="light"] {
            --bg: #f0f2f5;
            --card: #ffffff;
            --border: #e1e4e8;
            --text: #1a1a1a;
            --sub: #6e7781;
            --input-bg: #ffffff;
            --gold: #C9A66B;
            --gold-gradient: linear-gradient(135deg, #C9A66B 0%, #B08D55 100%);
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --chart-grid: #e1e4e8;
            --chart-text: #6e7781;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Manrope', sans-serif;
            overflow-x: hidden;
            font-size: 16px;
        }

        /* Typography */
        h1, h2, h3, .font-luxury { font-family: 'Cinzel', serif; }
        .text-gold { color: var(--gold); }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAVBAR --- */
        .navbar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 60px; background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 1000;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { 
            font-family: 'Cinzel'; font-weight: 700; font-size: 1.2rem; color: var(--gold); 
            letter-spacing: 1px; text-decoration: none; display: flex; gap: 5px;
        }
        .nav-logo span { color: var(--text); font-weight: 400; }
        
        .nav-tabs { display: flex; gap: 5px; align-items: center; font-size: 0.85rem; }
        .nav-item { color: var(--sub); padding: 5px 10px; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; }
        .nav-item.active { color: var(--text); font-weight: 700; }
        .nav-arrow { color: var(--sub); font-size: 0.7rem; }
        .nav-item.disabled { pointer-events: none; opacity: 0.5; }

        .nav-right { display: flex; align-items: center; gap: 15px; }
        .theme-toggle { background: none; border: 1px solid var(--border); color: var(--text); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- LAYOUT --- */
        .container { max-width: 1300px; margin: 0 auto; padding: 80px 20px 40px; }

        .card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 24px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .btn-gold {
            background: var(--gold-gradient); color: #fff; border: none;
            padding: 14px 24px; border-radius: 8px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            width: 100%; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-outline {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;
        }

        input {
            width: 100%; background: var(--input-bg); border: 1px solid var(--border);
            color: var(--text); padding: 14px; border-radius: 8px; outline: none;
            font-family: 'Manrope'; margin-bottom: 15px; font-size: 1rem;
        }
        input:focus { border-color: var(--gold); }

        /* --- DESKTOP GRID DEFAULTS --- */
        .split-screen { display: grid; grid-template-columns: 1fr 1.5fr; gap: 60px; height: calc(100vh - 140px); align-items: center; }
        .eda-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .dash-layout { display: grid; grid-template-columns: 2fr 1.3fr; gap: 30px; }
        .client-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .dash-header { display: flex; gap: 30px; align-items: center; margin-bottom: 40px; }

        /* --- COMPONENTS --- */
        .metric-box { padding: 20px; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .metric-lbl { font-size: 0.7rem; text-transform: uppercase; color: var(--sub); letter-spacing: 1px; margin-bottom: 5px; }
        .metric-val { font-family: 'Cinzel'; font-size: 1.6rem; font-weight: 700; color: var(--text); line-height: 1.2; }
        .metric-delta { font-size: 0.8rem; color: #2ea043; background: rgba(46, 160, 67, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }

        .filters { display: flex; gap: 10px; margin: 30px 0; overflow-x: auto; padding-bottom: 5px; -ms-overflow-style: none; scrollbar-width: none; }
        .filters::-webkit-scrollbar { display: none; }
        .filter-btn {
            background: transparent; border: 1px solid var(--border); color: var(--sub);
            padding: 8px 20px; border-radius: 30px; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; font-weight: 600; white-space: nowrap; flex-shrink: 0;
        }
        .filter-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201, 166, 107, 0.1); }
        
        .client-card { cursor: pointer; transition: 0.3s; }
        
        /* Updated Profile Icon (Clickable) */
        .profile-icon { 
            width: 45px; height: 45px; border-radius: 50%; 
            background: var(--bg); border: 1px solid var(--gold); 
            display: flex; align-items: center; justify-content: center; 
            color: var(--gold); font-size: 1.1rem; flex-shrink: 0; 
            cursor: pointer; transition: 0.3s;
        }
        .profile-icon:hover { background: var(--gold); color: #000; }
        
        .pill { display: inline-flex; align-items: center; justify-content: center; height: 24px; padding: 0 12px; border-radius: 12px; font-size: 0.65rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; line-height: 1; }
        .pill-VIP { border: 1px solid var(--gold); color: var(--gold); }
        .pill-Active { border: 1px solid #2ea043; color: #2ea043; }
        .pill-New { border: 1px solid #58a6ff; color: #58a6ff; }

        .dash-avatar { width: 90px; height: 90px; border-radius: 50%; border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; background: var(--bg); font-size: 2rem; color: var(--gold); }
        
        .script-box { background: rgba(0,0,0,0.05); border: 1px dashed var(--sub); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: var(--text); margin: 15px 0; white-space: pre-wrap; word-break: break-word; }
        .ai-analysis-box { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; line-height: 1.6; color: var(--sub); }
        .ai-highlight { color: var(--gold); font-weight: 500; }
        .ai-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .spinner { width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ApexCharts */
        .apexcharts-tooltip { background: var(--card) !important; border-color: var(--gold) !important; color: var(--text) !important; }
        .apexcharts-tooltip-title { background: var(--bg) !important; border-bottom: 1px solid var(--border) !important; font-family: 'Cinzel', serif !important; }
        .apexcharts-text { fill: var(--chart-text) !important; font-family: 'Manrope', sans-serif !important; }

        /* --- MODAL POPUP --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            width: 320px; text-align: center; position: relative;
            background: var(--card); border: 1px solid var(--gold);
            padding: 40px 20px; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .close-icon {
            position: absolute; top: 15px; right: 20px; font-size: 1.5rem;
            color: var(--sub); cursor: pointer; transition: 0.3s;
        }
        .close-icon:hover { color: var(--text); }
        
        .modal-avatar {
            width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px;
            border: 2px solid var(--gold); padding: 5px; object-fit: cover;
        }

        /* ========================================= */
        /* MOBILE RESPONSIVE                         */
        /* ========================================= */
        @media (max-width: 900px) {
            .container { padding: 75px 15px 20px; }
            .nav-tabs { display: none; } /* Hide Breadcrumbs */
            
            /* Login */
            .split-screen { display: flex; flex-direction: column; height: auto; gap: 30px; }
            .eda-grid { grid-template-columns: 1fr; gap: 15px; } 
            .kpi-grid { grid-template-columns: 1fr; gap: 15px; } 
            
            h1.font-luxury { font-size: 1.8rem !important; }
            
            /* Directory */
            .client-grid { grid-template-columns: 1fr; }
            
            /* Dashboard */
            .dash-layout { grid-template-columns: 1fr; gap: 20px; }
            .dash-header { flex-direction: column; text-align: center; gap: 15px; margin-bottom: 30px; }
            .metric-val { font-size: 1.5rem; }
        }
    </style>
</head>
<body data-theme="dark">

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="nav-left">
            <a href="#" class="nav-logo" onclick="location.reload()">SMINEX <span>CLUB</span></a>
            
            <div class="nav-tabs">
                <div id="nav-login" class="nav-item active">CLUB ACCESS</div>
                <i class="fa-solid fa-chevron-right nav-arrow"></i>
                <div id="nav-directory" class="nav-item disabled" onclick="goTo('directory')">MEMBERS</div>
                <i class="fa-solid fa-chevron-right nav-arrow"></i>
                <div id="nav-dashboard" class="nav-item disabled">PROFILE</div>
            </div>
        </div>

        <div class="nav-right">
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fa-solid fa-sun" id="theme-icon"></i>
            </button>
            <!-- Added onclick to trigger modal -->
            <div class="profile-icon" onclick="toggleProfile()">
                <i class="fa-solid fa-user-tie"></i>
            </div>
        </div>
    </nav>

    <!-- PROFILE MODAL (POPUP) -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content fade-in">
            <span class="close-icon" onclick="toggleProfile()">×</span>
            
            <div style="display: flex; justify-content: center;">
                <div class="profile-icon" style="width: 80px; height: 80px; font-size: 2.5rem; cursor: default; margin-bottom: 20px;">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
            </div>
            
            <h2 class="font-luxury" style="margin-bottom: 5px; font-size: 1.5rem;">ILIA</h2>
            <p style="color: var(--gold); font-size: 0.9rem; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 1px;">
                Sales Manager<br>Sminex Club
            </p>
            
            <button class="btn-outline" onclick="logout()" style="border-color: var(--border); color: var(--sub);">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> LOG OUT
            </button>
        </div>
    </div>

    <!-- PAGE 1: LOGIN -->
    <section id="page-login" class="container">
        <div class="split-screen">
            <div class="card fade-in">
                <h1 class="font-luxury" style="color: var(--gold); font-size: 2.5rem; margin-bottom: 10px;">SMINEX CLUB</h1>
                <p style="color: var(--sub); letter-spacing: 2px; font-size: 0.8rem; margin-bottom: 40px;">LOYALTY & REPEAT SALES SYSTEM</p>
                
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 0.75rem; color: var(--sub); text-transform: uppercase;">Manager Token</label>
                    <input type="password" id="password" placeholder="Enter secure key...">
                </div>
                
                <button class="btn-gold" onclick="attemptLogin()">
                    <span id="login-text">ACCESS CLUB DATABASE</span>
                    <div id="login-spinner" class="spinner hidden"></div>
                </button>
                
                <p style="margin-top:20px; font-size:0.8rem; color:var(--sub); text-align:center;">
                    <i class="fa-solid fa-shield-halved"></i> Exclusive Real Estate Ecosystem
                </p>
            </div>

            <div class="fade-in" style="animation-delay: 0.2s;">
                <div class="eda-grid">
                    <div class="card metric-box">
                        <div class="metric-lbl">Club Members</div>
                        <div class="metric-val">12,450 <span class="metric-delta">+8.2%</span></div>
                    </div>
                    <div class="card metric-box">
                        <div class="metric-lbl">Assets Under Mgmt</div>
                        <div class="metric-val">248 МЛРД <span class="metric-delta">+5%</span></div>
                    </div>
                    <div class="card metric-box">
                        <div class="metric-lbl">Repeat Sales Rate</div>
                        <div class="metric-val">34.8% <span class="metric-delta">+1.2%</span></div>
                    </div>
                    <div class="card metric-box">
                        <div class="metric-lbl">Avg LTV</div>
                        <div class="metric-val">65 МЛН ₽</div>
                    </div>
                </div>
                
                <div class="card" style="padding: 20px;">
                    <div class="metric-lbl" style="margin-bottom: 10px;">CLUB SALES DYNAMICS (YTD)</div>
                    <div id="login-chart"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- PAGE 2: DIRECTORY -->
    <section id="page-directory" class="container hidden">
        <div class="fade-in">
            <h1 class="font-luxury" style="font-size: 2rem; margin-bottom: 10px;">CLUB MEMBERS</h1>
            <p style="color: var(--sub); font-size: 0.8rem;">IDENTIFYING OPPORTUNITIES</p>

            <input type="text" id="search" placeholder="Search Member..." style="margin-top: 20px;" onkeyup="renderDirectory()">

            <div class="filters">
                <button class="filter-btn active" onclick="setFilter('All', this)">ALL MEMBERS</button>
                <button class="filter-btn" onclick="setFilter('VIP', this)">VIP RESIDENTS</button>
                <button class="filter-btn" onclick="setFilter('Active', this)">ACTIVE INVESTORS</button>
                <button class="filter-btn" onclick="setFilter('New', this)">NEW OWNERS</button>
            </div>

            <div id="client-grid" class="client-grid"></div>
        </div>
    </section>

    <!-- PAGE 3: DASHBOARD -->
    <section id="page-dashboard" class="container hidden">
        <div class="fade-in">
            <button onclick="goTo('directory')" style="background:none; border:none; color:var(--sub); margin-bottom:15px; display:flex; align-items:center; gap:5px; cursor:pointer;">
                <i class="fa-solid fa-arrow-left"></i> Back to Directory
            </button>
            
            <!-- Header -->
            <div id="dash-header-content"></div>

            <!-- Layout -->
            <div class="dash-layout">
                <!-- Left: Analytics -->
                <div>
                    <!-- KPI Row -->
                    <div class="kpi-grid">
                        <div class="card metric-box" style="text-align: center;">
                            <div class="metric-lbl">TOTAL INVESTED</div>
                            <div class="metric-val" id="kpi-invested"></div>
                        </div>
                        <div class="card metric-box" style="text-align: center;">
                            <div class="metric-lbl">DEALS CLOSED</div>
                            <div class="metric-val" id="kpi-deals"></div>
                        </div>
                        <div class="card metric-box" style="text-align: center;">
                            <div class="metric-lbl">AVG TICKET</div>
                            <div class="metric-val" id="kpi-avg"></div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="card" style="margin-top: 20px;">
                        <h3 class="font-luxury" style="font-size: 1rem; margin-bottom: 20px;">PORTFOLIO GROWTH</h3>
                        <div id="dash-chart"></div>
                    </div>

                    <!-- AI Analysis -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="ai-header">
                            <i class="fa-solid fa-microchip text-gold"></i>
                            <h3 class="font-luxury" style="font-size: 1rem; margin:0;">AI CLUB ANALYSIS</h3>
                        </div>
                        <div id="ai-analysis-content" class="ai-analysis-box"></div>
                    </div>
                </div>

                <!-- Right: Actions & Offer -->
                <div class="card">
                    <h3 class="font-luxury" style="font-size: 1rem; margin-bottom: 15px;">MANAGER ACTIONS</h3>
                    <div style="font-size: 0.9rem; color: var(--sub); margin-bottom: 10px;">CRM NOTE:</div>
                    <div id="manager-note" style="font-style: italic; color: var(--text); margin-bottom: 20px;"></div>
                    
                    <hr style="border-color: var(--border); opacity: 0.5; margin: 20px 0;">
                    
                    <button id="generate-btn" class="btn-gold" onclick="generateOffer()">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> GENERATE CLUB OFFER
                    </button>

                    <!-- AI OFFER BOX -->
                    <div id="ai-offer-box" class="hidden" style="margin-top: 20px;">
                        <div style="background: rgba(201, 166, 107, 0.1); border: 1px solid var(--gold); border-radius: 8px; padding: 15px;">
                            <h4 class="text-gold" style="margin-bottom: 10px;">CROSS-SELL RECOMMENDATION</h4>
                            <div id="offer-details" style="font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;"></div>
                            
                            <div style="font-size: 0.75rem; color: var(--sub); text-transform: uppercase; margin-bottom: 5px;">MESSENGER SCRIPT:</div>
                            <div class="script-box" id="sales-script"></div>
                            
                            <button class="btn-outline" onclick="copyScript(this)">
                                <i class="fa-regular fa-copy"></i> COPY SCRIPT
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

<script>
    // --- DATA GENERATOR ---
    const generateClients = () => {
        const firstNames = ["James", "Robert", "John", "Michael", "David", "William", "Richard", "Joseph", "Thomas", "Charles", "Mary", "Patricia", "Jennifer", "Linda", "Elizabeth", "Barbara", "Susan", "Jessica", "Sarah", "Karen"];
        const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson"];
        const notes = [
            "Ищет объект для детей. Важна близость к паркам.",
            "Только закрытые продажи. Строгая конфиденциальность.",
            "Рассматривает инвестиционные лоты с доходностью от 15%.",
            "Интересуется коммерческой недвижимостью в ЦАО.",
            "Любит видовые пентхаусы. Бюджет не ограничен."
        ];

        let generated = [];
        for (let i = 0; i < 30; i++) {
            let isHidden = Math.random() < 0.2; 
            let dealsCount = Math.floor(Math.random() * 5) + 1;
            
            let dealsHistory = [];
            let totalInvested = 0;
            let lastDate = new Date(2021, 0, 1);
            
            for(let j=0; j < dealsCount; j++) {
                let daysToAdd = Math.floor(Math.random() * 300) + 30;
                let dealDate = new Date(lastDate);
                dealDate.setDate(dealDate.getDate() + daysToAdd);
                lastDate = dealDate;
                
                let amount = (Math.floor(Math.random() * 50) + 15) * 1000000;
                totalInvested += amount;
                
                dealsHistory.push({
                    date: dealDate.toISOString().split('T')[0],
                    amount: amount,
                    cumulative: totalInvested
                });
            }

            let status = totalInvested > 150000000 ? "VIP" : (dealsCount === 1 ? "New" : "Active");

            generated.push({
                id: "79" + Math.floor(Math.random() * 90000000 + 10000000),
                name: isHidden ? "PRIVATE CLIENT" : firstNames[Math.floor(Math.random() * firstNames.length)] + " " + lastNames[Math.floor(Math.random() * lastNames.length)],
                isHidden: isHidden,
                status: status,
                invested: totalInvested,
                deals: dealsCount,
                history: dealsHistory,
                last: dealsHistory[dealsHistory.length-1].date,
                note: notes[Math.floor(Math.random() * notes.length)]
            });
        }
        return generated.sort((a,b) => b.invested - a.invested);
    };

    const clients = generateClients();

    let currentFilter = 'All';
    let currentClient = null;
    let isDark = true;

    function formatMoney(amount) {
        if (amount >= 1e9) return (amount / 1e9).toFixed(2) + ' МЛРД ₽';
        if (amount >= 1e6) return (amount / 1e6).toFixed(1) + ' МЛН ₽';
        return amount.toLocaleString() + ' ₽';
    }

    function toggleTheme() {
        isDark = !isDark;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        const icon = document.getElementById('theme-icon');
        icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        renderLoginChart(); 
        if(currentClient) renderDashChart();
    }

    // --- MODAL LOGIC ---
    function toggleProfile() {
        const modal = document.getElementById('profile-modal');
        modal.classList.toggle('hidden');
    }

    function logout() {
        toggleProfile(); // close modal
        goTo('login');
    }

    // Close modal when clicking outside content
    window.onclick = function(event) {
        const modal = document.getElementById('profile-modal');
        if (event.target == modal) {
            toggleProfile();
        }
    }

    // --- NAVIGATION ---
    function updateBreadcrumbs(page) {
        const navLogin = document.getElementById('nav-login');
        const navDir = document.getElementById('nav-directory');
        const navDash = document.getElementById('nav-dashboard');
        [navLogin, navDir, navDash].forEach(el => { el.classList.remove('active'); el.classList.add('disabled'); });

        if (page === 'login') navLogin.classList.add('active');
        else if (page === 'directory') { navLogin.classList.remove('disabled'); navDir.classList.add('active'); }
        else if (page === 'dashboard') { navLogin.classList.remove('disabled'); navDir.classList.remove('disabled'); navDash.classList.add('active'); }
    }

    function goTo(pageId) {
        document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`page-${pageId}`).classList.remove('hidden');
        window.scrollTo(0,0);
        updateBreadcrumbs(pageId);
        if(pageId === 'directory') renderDirectory();
    }

    function attemptLogin() {
        const btnText = document.getElementById('login-text');
        const spinner = document.getElementById('login-spinner');
        btnText.classList.add('hidden');
        spinner.classList.remove('hidden');
        setTimeout(() => { goTo('directory'); btnText.classList.remove('hidden'); spinner.classList.add('hidden'); }, 1000);
    }

    function renderLoginChart() {
        const color = '#C9A66B';
        const options = {
            series: [{ name: 'Repeat Sales Volume', data: [30, 40, 35, 50, 49, 60, 70, 91, 125, 140] }],
            chart: { type: 'area', height: 200, toolbar: { show: false }, background: 'transparent' },
            colors: [color],
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 90, 100] } },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: { 
                categories: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct'], 
                labels: { style: { colors: 'var(--chart-text)', fontFamily: 'Manrope' } },
                axisBorder: { show: false }, axisTicks: { show: false }
            },
            yaxis: { show: true, labels: { style: { colors: 'var(--chart-text)', fontFamily: 'Manrope' } } },
            grid: { borderColor: 'var(--chart-grid)', strokeDashArray: 4 },
            legend: { show: true, labels: { colors: 'var(--text)' } },
            tooltip: { theme: isDark ? 'dark' : 'light' }
        };
        document.getElementById('login-chart').innerHTML = '';
        new ApexCharts(document.querySelector("#login-chart"), options).render();
    }

    function setFilter(status, btn) {
        currentFilter = status;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderDirectory();
    }

    function renderDirectory() {
        const grid = document.getElementById('client-grid');
        const search = document.getElementById('search').value.toLowerCase();
        grid.innerHTML = '';
        
        const filtered = clients.filter(c => {
            const matchStatus = currentFilter === 'All' || c.status === currentFilter;
            const matchSearch = c.name.toLowerCase().includes(search) || c.id.includes(search);
            return matchStatus && matchSearch;
        });

        filtered.forEach(client => {
            const div = document.createElement('div');
            div.className = 'card client-card fade-in';
            div.onclick = () => openDashboard(client);
            const nameStyle = client.isHidden ? 'color: var(--sub); font-style: italic;' : '';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom:15px;">
                    <div class="profile-icon"><i class="fa-solid fa-user"></i></div>
                    <span class="pill pill-${client.status}">${client.status}</span>
                </div>
                <div class="font-luxury" style="font-weight:600; font-size:1.1rem; margin-bottom:5px; ${nameStyle}">${client.name}</div>
                <div style="font-size:0.75rem; color:var(--sub); margin-bottom:20px;">ID: ${client.id}</div>
                <div style="border-top:1px solid var(--border); padding-top:15px; display:flex; justify-content:space-between;">
                    <div><div style="font-size:0.65rem; color:var(--sub);">TOTAL</div><div style="font-weight:700;">${formatMoney(client.invested).replace(' ₽','')}</div></div>
                    <div style="text-align:right;"><div style="font-size:0.65rem; color:var(--sub);">LATEST</div><div style="font-weight:700;">${client.last}</div></div>
                </div>
            `;
            grid.appendChild(div);
        });
    }

    // --- AI ANALYSIS ---
    function generateAnalysisText(client) {
        let avg = client.invested / client.deals;
        let text = "";

        if (client.status === "VIP") {
            text += `Участник Sminex Club с высоким LTV. Паттерн "Trophy Assets" (Трофейная недвижимость). Средний чек сделки <span class="ai-highlight">${formatMoney(avg)}</span> указывает на предпочтение сегмента De Luxe. Интервалы между покупками свидетельствуют о долгосрочной стратегии сохранения капитала.<br><br>`;
            text += `<strong>Рекомендация:</strong> Предлагать эксклюзивные лоты (Closed Sales) для пополнения коллекции активов.`;
        } else if (client.status === "New") {
            text += `Новый резидент Клуба. Первая инвестиция объемом <span class="ai-highlight">${formatMoney(client.invested)}</span> ("Entry Point"). Высокий потенциал для Upsell на паркинг или кладовые помещения в течение 3 месяцев.<br><br>`;
            text += `<strong>Стратегия:</strong> Развитие лояльности через сервисные предложения и приглашения на мероприятия Клуба.`;
        } else {
            text += `Активный инвестор Клуба. Диверсифицированный портфель (${client.deals} сделок). Динамика покупок указывает на стратегию расширения жилой площади или инвестиционных вложений.<br><br>`;
            text += `<strong>Интересы:</strong> Ликвидность и потенциал роста стоимости кв. м.`;
        }
        text += `<br><br><strong>AI Prediction:</strong> Вероятность повторной покупки в течение 6 месяцев: 87%. Рекомендуемый проект: Life Time или Тишинский Бульвар.`;
        return text;
    }

    function openDashboard(client) {
        currentClient = client;
        document.getElementById('ai-offer-box').classList.add('hidden');
        document.getElementById('generate-btn').innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> GENERATE CLUB OFFER';
        document.getElementById('generate-btn').disabled = false;
        
        const nameDisplay = client.isHidden ? 'PRIVATE CLIENT' : client.name;
        document.getElementById('dash-header-content').innerHTML = `
            <div class="dash-header">
                <div class="dash-avatar"><i class="fa-solid fa-user"></i></div>
                <div>
                    <h1 class="font-luxury" style="font-size: 2rem; margin-bottom: 5px;">${nameDisplay}</h1>
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center;">
                        <span style="color: var(--sub); letter-spacing: 1px; font-size:0.8rem;">ID: ${client.id}</span>
                        <span class="pill pill-${client.status}">${client.status} MEMBER</span>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('kpi-invested').innerText = formatMoney(client.invested);
        document.getElementById('kpi-deals').innerText = client.deals;
        document.getElementById('kpi-avg').innerText = formatMoney(client.invested / client.deals);
        
        document.getElementById('manager-note').innerText = `"${client.note}"`;
        document.getElementById('ai-analysis-content').innerHTML = generateAnalysisText(client);

        goTo('dashboard');
        renderDashChart();
    }

    function renderDashChart() {
        let seriesData = [];
        let startDate = new Date(new Date(currentClient.history[0].date).setMonth(new Date(currentClient.history[0].date).getMonth() - 1));
        seriesData.push([startDate.getTime(), 0]);

        currentClient.history.forEach(deal => {
            seriesData.push([new Date(deal.date).getTime(), deal.cumulative]);
        });
        seriesData.push([new Date().getTime(), currentClient.invested]);

        const options = {
            series: [{ name: 'Assets Value', data: seriesData }],
            chart: { type: 'area', height: 300, toolbar: { show: false }, background: 'transparent', animations: { enabled: true } },
            colors: ['#C9A66B'],
            stroke: { curve: 'stepline', width: 2 },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.3, opacityTo: 0.05, stops: [0, 100] } },
            dataLabels: { enabled: false },
            xaxis: { type: 'datetime', labels: { style: { colors: 'var(--chart-text)', fontFamily: 'Manrope' }, datetimeFormatter: { year: 'yyyy', month: 'MMM yy' } }, axisBorder: { show: false }, axisTicks: { show: false }, tooltip: { enabled: false } },
            yaxis: { show: true, labels: { style: { colors: 'var(--chart-text)', fontFamily: 'Manrope' }, formatter: (val) => { return (val/1000000).toFixed(0) + "M" } } },
            grid: { borderColor: 'var(--chart-grid)', strokeDashArray: 4 },
            tooltip: { theme: isDark ? 'dark' : 'light', x: { format: 'dd MMM yyyy' }, y: { formatter: function (val) { return formatMoney(val) } } }
        };
        document.getElementById('dash-chart').innerHTML = '';
        new ApexCharts(document.querySelector("#dash-chart"), options).render();
    }

    function generateOffer() {
        const btn = document.getElementById('generate-btn');
        const box = document.getElementById('ai-offer-box');
        btn.innerHTML = '<div class="spinner"></div>';
        setTimeout(() => {
            btn.innerHTML = '<i class="fa-solid fa-check"></i> OFFER GENERATED';
            btn.disabled = true;
            box.classList.remove('hidden');
            box.classList.add('fade-in');
            
            let project = currentClient.invested > 100000000 ? "LAVRUSHINSKY" : "LIFE TIME";
            let price = currentClient.invested > 100000000 ? "185 МЛН ₽" : "58 МЛН ₽";
            let lot = currentClient.invested > 100000000 ? "Penthouse (Kremlin View)" : "3-bedroom (Presnya)";
            let clientName = currentClient.isHidden ? "Client" : currentClient.name.split(' ')[0];

            document.getElementById('offer-details').innerHTML = `
                <b>Project:</b> ${project}<br><b>Lot:</b> ${lot}<br><b>Entry:</b> <span class="text-gold" style="font-weight:700">${price}</span>
            `;
            document.getElementById('sales-script').innerText = `Здравствуйте, ${clientName}!

Как участнику Sminex Club, хочу предложить вам эксклюзивный лот в проекте ${project}.

Это ${lot.toLowerCase()}. Сейчас закрытый этап продаж для резидентов Клуба. Цена — ${price}.

Когда вам удобно обсудить детали?`;
        }, 1200);
    }

    function copyScript(btn) {
        const text = document.getElementById('sales-script').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> COPIED';
            setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
        });
    }

    renderLoginChart();

</script>
</body>
</html>
